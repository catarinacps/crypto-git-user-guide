<!doctype html>
<html lang="pt_BR">
<head>
<title>Utilizando um remoto git criptografado</title>
<!-- 2020-02-18 ter 17:31 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Henrique Corrêa Pereira da Silva">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Utilizando um remoto git criptografado</h1>
<p>
Bem-vindo! Nesse guia espero apresentar passo a passo a configuração e
utilização de uma máquina remota hospedando um repositório <code>git</code> criptografado,
assim como a criptografia do clone local do repositório.
</p>

<p>
Esse guia está subdividido a partir das duas perspectivas de potenciais
usuários: <b>administrador</b> e <b>desenvolvedor</b>. Isto é, focaremos inicialmente na
hospedagem de um servidor e na configuração inicial do repositório, e logo após
no <i>workflow</i> do usuário utilizando esse servidor para trabalhar no repositório
ali hospedado.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Sumário</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><a href="#sec-2">Preâmbulo</a>
<ul class="org-ul">
<li><a href="#sec-2-1"><code>git</code></a>
</li>
<li><a href="#sec-2-2"><code>gnupg</code></a>
</li>
<li><a href="#sec-2-3"><code>git-remote-gcrypt</code></a>
</li>
<li><a href="#sec-2-4"><code>ecryptfs</code></a>
</li>
</ul>
</li>
<li><a href="#sec-3">Hospedando o servidor</a>
<ul class="org-ul">
<li><a href="#sec-3-1">Crie um usuário chamado "git" e um diretório <code>.ssh</code> para ele</a>
</li>
<li><a href="#sec-3-2">Adicione os colaboradores</a>
</li>
<li><a href="#sec-3-3">Crie o repositório no servidor</a>
</li>
<li><a href="#sec-3-4">Inicialize a cópia local</a>
<ul class="org-ul">
<li><a href="#sec-3-4-1">Criando um diretório criptografado</a>
</li>
<li><a href="#sec-3-4-2">Importando as chaves dos colaboradores</a>
</li>
<li><a href="#sec-3-4-3">Criando a primeira versão</a>
</li>
</ul>
</li>
<li><a href="#sec-3-5">Configure o usuário</a>
</li>
</ul>
</li>
<li><a href="#sec-4">Utilizando o servidor</a>
<ul class="org-ul">
<li><a href="file:///Clone/ do repositório"><i>Clone</i> do repositório</a>
</li>
<li><a href="file:///Mount/ e /Unmount/ do diretório privado criptografado"><i>Mount</i> e <i>Unmount</i> do diretório privado criptografado</a>
</li>
<li><a href="#sec-4-3">Trabalho no repositório</a>
</li>
<li><a href="#sec-4-4">Utilização de submódulos</a>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Preâmbulo</h2>
<div class="outline-text-2" id="text-2">
<p>
Antes de criar ou de trabalhar com esse servidor remoto, necessitaremos de
algumas ferramentas instaladas nas nossas máquinas:
</p>

<ul class="org-ul">
<li><a href="https://git-scm.com/">git</a>
</li>
<li><a href="https://gnupg.org/">gnupg</a>
</li>
<li><a href="https://spwhitton.name/tech/code/git-remote-gcrypt/">git-remote-gcrypt</a>
</li>
<li><a href="https://ecryptfs.org/">ecryptfs</a>
</li>
</ul>

<p>
Nessas subseções abordaremos o processo de instalação dessas ferramentas.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> <code>git</code></h3>
<div class="outline-text-3" id="text-2-1">
<p>
Criada por Linus Torvalds a fim de versionar atualizações ao kernel linux, essa
ferramenta está presente em todos os repositórios de pacotes de quaisquer
distribuições.
</p>

<p>
Dependendo de sua distribuição GNU/Linux, faça o seguinte para instalar o
pacote:
</p>

<dl class="org-dl">
<dt> Debian/Ubuntu </dt><dd><code>sudo apt-get install git</code>
</dd>
<dt> Fedora </dt><dd><code>sudo yum install git</code>
</dd>
<dt> OpenSUSE </dt><dd><code>sudo zypper install git</code>
</dd>
<dt> Arch </dt><dd><code>sudo pacman -S git</code>
</dd>
<dt> Gentoo </dt><dd><code>sudo apk add git</code>
</dd>
</dl>

<p>
Se utilizar Windows 10, considere habilitar o
<a href="https://docs.microsoft.com/pt-br/windows/wsl/install-win10">subsistema Windows
para Linux</a> ou instale Git for Windows através desse
<a href="https://git-scm.com/download/win">link</a>.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> <code>gnupg</code></h3>
<div class="outline-text-3" id="text-2-2">
<p>
A implementação do grupo GNU da especificação OpenPGP é uma das ferramentas mais
populares para criptografia de dados e gerenciamento de chaves, e está presente
em virtualmente todos os repositórios de pacotes de grandes distribuições.
</p>

<p>
Para instalar, faça o seguintes comandos, dependendo de sua distribuição:
</p>

<dl class="org-dl">
<dt> Debian/Ubuntu </dt><dd><code>sudo apt-get install gnupg</code>
</dd>
<dt> Fedora </dt><dd><code>sudo yum install gnupg</code>
</dd>
<dt> OpenSUSE </dt><dd><code>sudo zypper install gnupg</code>
</dd>
<dt> Arch </dt><dd><code>sudo pacman -S gnupg</code>
</dd>
<dt> Gentoo </dt><dd><code>sudo apk add gnupg</code>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> <code>git-remote-gcrypt</code></h3>
<div class="outline-text-3" id="text-2-3">
<p>
Ferramenta que auxilia a criptografia completa de remotos utilizando chaves
públicas <code>gnupg</code> dos participantes do repositório.
</p>

<p>
Para instalar:
</p>

<dl class="org-dl">
<dt> Debian/Ubuntu </dt><dd><code>sudo apt-get install git-remote-gcrypt</code>
</dd>
<dt> AUR (Arch) </dt><dd><code>yay -Sa git-remote-gcrypt</code>
</dd>
</dl>

<p>
Caso você não utilize essas distribuições, siga os seguintes passos:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">usuario@pc-local</span>

<span style="color: #d3869b;">git</span> clone https://github.com/spwhitton/git-remote-gcrypt.git
<span style="color: #fe8019;">cd</span> git-remote-gcrypt
./install.sh
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> <code>ecryptfs</code></h3>
<div class="outline-text-3" id="text-2-4">
<p>
Chamado também de "gnupg para filesystems", essa é a ferramenta por trás da
criptografia do diretório Home nativa da distribuição Ubuntu. O código fonte da
ferramenta foi integrado no repositório do kernel Linux, e o pacote para a
utilização simples em linha de comando pode ser instalada da seguinte maneira:
</p>

<dl class="org-dl">
<dt> Debian/Ubuntu </dt><dd><code>sudo apt-get install ecryptfs-utils</code>
</dd>
<dt> Fedora </dt><dd><code>sudo yum install ecryptfs-utils</code>
</dd>
<dt> OpenSUSE </dt><dd><code>sudo zypper install ecryptfs-utils</code>
</dd>
<dt> Arch </dt><dd><code>sudo pacman -S ecryptfs-utils</code>
</dd>
<dt> Gentoo </dt><dd><code>sudo apk add ecryptfs-utils</code>
</dd>
</dl>

<p>
Podemos agora facilmente criar um diretório privado para cada usuário utilizando
essas ferramentas, porém note que, utilizando interfaces menos simples, é
possível criar mais diretórios transparentes.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Hospedando o servidor</h2>
<div class="outline-text-2" id="text-3">
<p>
Primeiramente, no servidor remoto você só necessitará do programa <code>git</code>
instalado, além de um pacote que implementa o protocolo <code>ssh</code>, como o <code>OpenSSH</code>.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Crie um usuário chamado "git" e um diretório <code>.ssh</code> para ele</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Realize os seguintes comandos:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@servidor-remoto</span>

<span style="color: #d3869b;">sudo</span> adduser <span style="color: #d3869b;">git</span>
<span style="color: #d3869b;">su</span> <span style="color: #d3869b;">git</span>
<span style="color: #fe8019;">cd</span> ~
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">criando o reposit&#243;rio .ssh</span>
<span style="color: #d3869b;">mkdir</span> .ssh &amp;&amp; <span style="color: #d3869b;">chmod</span> 700 .ssh
<span style="color: #d3869b;">touch</span> .ssh/authorized_keys &amp;&amp; <span style="color: #d3869b;">chmod</span> 600 .ssh/authorized_keys
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Adicione os colaboradores</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Primeiro peça aos colaboradores que enviem suas chaves públicas:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">usuario@pc-local</span>

<span style="color: #d3869b;">cat</span> $<span style="color: #83a598;">HOME</span>/.ssh/*.pub
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">os nomes padr&#227;o para chaves s&#227;o id_* </span><span style="color: #7c6f64;">e</span><span style="color: #7c6f64;"> id_*.pub</span>
</pre>
</div>

<p>
Agora, adicione as chaves SSH dos colaboradores de repositórios nesse servidor.
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">git</span><span style="color: #7c6f64;">@servidor-remoto</span>

<span style="color: #d3869b;">cat</span> &lt;caminho para a chave p&#250;blica de Jo&#227;o&gt; &gt;&gt; ~/.ssh/authorized_keys
<span style="color: #d3869b;">cat</span> &lt;caminho para a chave p&#250;blica de Maria&gt; &gt;&gt; ~/.ssh/authorized_keys
<span style="color: #d3869b;">cat</span> &lt;caminho para a chave p&#250;blica de Jos&#233;&gt; &gt;&gt; ~/.ssh/authorized_keys
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Crie o repositório no servidor</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Com os usuários autorizados para a comunicação por SSH, inicie o repositório
numa pasta que julgar adequada.
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">git</span><span style="color: #7c6f64;">@servidor-remoto</span>

<span style="color: #d3869b;">mkdir</span> -p /srv/git &amp;&amp; <span style="color: #fe8019;">cd</span> /srv/git
<span style="color: #d3869b;">mkdir</span> projeto.git
<span style="color: #fe8019;">cd</span> projeto.git
<span style="color: #d3869b;">git</span> init --bare
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Inicialize a cópia local</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Como esse guia visa a criação de um repositório hospedado localmente e
criptografado em ambos remoto e cópias locais, precisamos, antes de criar o
primeiro <code>commit</code> do repositório, inicializar nossas ferramentas de
criptografia.
</p>
</div>

<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> Criando um diretório criptografado</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Utilizando a ferramenta <code>ecryptfs</code>, criaremos um diretório privado para o
usuário na sua Home, com o intuito de guardar os dados do repositório remoto.
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

ecryptfs-setup-private --nopwcheck --noautomount
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">o mount point default &#233; em ~/Private</span>
<span style="color: #d3869b;">mv</span> ~/Private ~/meu_projeto
<span style="color: #fe8019;">echo</span> $(readlink -f meu_projeto) &gt; ~/.ecryptfs/Private.mnt
ecryptfs-mount-private
</pre>
</div>

<p>
Assim teremos um diretório criptografado de maneira transparente pela
ferramenta.
</p>
</div>
</div>

<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> Importando as chaves dos colaboradores</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
Para importar as chaves privadas dos colaboradores, peça que executem os
seguintes comandos:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

gpg --list-keys --keyid-format long
</pre>
</div>

<p>
Na saída do comando, os usuários verão uma lista no seguinte formato:
</p>

<pre class="example">
/home/&lt;USER&gt;/.gnupg/pubring.kbx
---------------------------------
pub   &lt;TIPO_E_TAMANHO&gt;/&lt;ID_LONGO&gt; &lt;DATA_CRIACAO&gt;
      &lt;FINGERPRINT_COMPLETO&gt;
uid                 &lt;COMENTARIOS&gt;
sub   &lt;TIPO_E_TAMANHO&gt;/&lt;ID_SUBCHAVE&gt; &lt;DATA_CRIACAO&gt; [E]
</pre>

<p>
Após identificar a chave que escolheram, peça que exportem a chave através do
seguinte comando:
</p>

<div class="org-src-container">

<pre class="src src-bash">gpg --armor --export &lt;ID_LONGO&gt; &gt; chave_joao.asc
</pre>
</div>

<p>
E que enviem esse arquivo para o administrador responsável. Assim, para importar
as chaves dos colaboradores, execute:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

gpg --import chave_joao.asc
gpg --import chave_maria.asc
gpg --import chave_jose.asc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4-3" class="outline-4">
<h4 id="sec-3-4-3"><span class="section-number-4">3.4.3</span> Criando a primeira versão</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
Agora podemos iniciar a configuração da criptografia do remoto através do URI
especial da ferramenta <code>git-remote-gcrypt</code>:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

<span style="color: #fe8019;">cd</span> ~/meu_projeto
<span style="color: #d3869b;">git</span> init
<span style="color: #d3869b;">git</span> remote add origin gcrypt::<span style="color: #d3869b;">git</span>@servidor:/srv/git/projeto.git
</pre>
</div>

<p>
e agora adicionamos as chaves <code>gpg</code> dos colaboradores:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">para visualizar as chaves p&#250;blicas no seu keyring, utilize:</span>
gpg --list-keys --keyid-format long
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">adicione as chaves publicas dos participantes:</span>
<span style="color: #d3869b;">git</span> config remote.cryptremote.gcrypt-participants <span style="color: #b8bb26;">\</span>
    <span style="color: #b8bb26;">"ID-CHAVE-JO&#195;O ID-CHAVE-MARIA ID-CHAVE-JOS&#201;"</span>
</pre>
</div>

<p>
Agora podemos finalmente inicializar o repositório com arquivos:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@pc-local</span>

vim README.md
<span style="color: #d3869b;">git</span> add README.md
<span style="color: #d3869b;">git</span> commit -m <span style="color: #b8bb26;">"commit inicial"</span>
<span style="color: #d3869b;">git</span> push -u origin master
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Configure o usuário</h3>
<div class="outline-text-3" id="text-3-5">
<p>
A fim de que esse usuário somente realize comandos <code>git</code>, altere sua <code>shell</code>
padrão para a <code>git-shell</code>, que está incluída no pacote <code>git</code>.
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">admin@servidor-remoto</span>

<span style="color: #d3869b;">sudo</span> chsh <span style="color: #d3869b;">git</span> -s $(<span style="color: #d3869b;">which</span> git-shell)
</pre>
</div>

<p>
Assim, nenhum dos colaboradores que adicionaremos poderá iniciar uma sessão
interativa por SSH pelo usuário git.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Utilizando o servidor</h2>
<div class="outline-text-2" id="text-4">
<p>
Com o repositório configurado e clonado na sua máquina, nessa subseção
abordaremos algumas ações comuns ao utilizar esse servidor.
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> <i>Clone</i> do repositório</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Se um colaborador quiser clonar o repositório <b>já configurado</b>, utilize o
<i>script</i> <a href="./scripts/clone.sh">clone.sh</a>.
</p>

<p>
O <i>script</i> por completo é esse (a conversão do GitHub para markdown não suporta
<i>includes</i> de arquivos externos):
</p>

<div class="org-src-container">

<pre class="src src-shell"><span style="color: #7c6f64;">#</span><span style="color: #7c6f64;">!/bin/</span><span style="color: #fb4933;">sh</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">author: @hcpsilva</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">crashes if an error occurs</span>
<span style="color: #fe8019;">set</span> -euf

<span style="color: #fabd2f;">usage</span>() {
<span style="color: #d3869b;">cat</span> &lt;&lt;EOF
<span style="color: #fe8019;">  $0 [OPTIONS] &lt;URI&gt;</span>

<span style="color: #fe8019;">  WHERE [OPTIONS] can be any of the following, in no particular order:</span>
<span style="color: #fe8019;">    -h | --help</span>
<span style="color: #fe8019;">      shows this message and quits</span>
<span style="color: #fe8019;">    -p | --prefix &lt;PATH&gt;</span>
<span style="color: #fe8019;">      uses a custom prefix instead of the default $HOME</span>
<span style="color: #fe8019;">    -d | --directory &lt;PATH&gt;</span>
<span style="color: #fe8019;">      uses a custom directory instead of the default repo name</span>
<span style="color: #fe8019;">    -v | --verbose</span>
<span style="color: #fe8019;">      be verbose</span>

<span style="color: #fe8019;">  WHERE &lt;URI&gt; is the URI of your existing repo, ssh format, e.g.:</span>
<span style="color: #fe8019;">    \"</span><span style="color: #fe8019;">git</span><span style="color: #fe8019;">@server:/srv/git/repo.git\"</span>
<span style="color: #fe8019;">EOF</span>
}

<span style="color: #fb4933;">for</span> arg; <span style="color: #fb4933;">do</span>
    <span style="color: #fb4933;">case</span> $<span style="color: #83a598;">arg</span><span style="color: #fb4933;"> in</span>
        -h|--help)
            <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"USAGE:"</span>
            usage
            <span style="color: #fe8019;">exit</span>
            ;;
        -p|--prefix)
            <span style="color: #fe8019;">shift</span>
            <span style="color: #83a598;">PREFIX</span>=<span style="color: #b8bb26;">"</span><span style="color: #fdf4c1; background-color: #282828;">$</span><span style="color: #83a598;">1</span><span style="color: #b8bb26;">"</span>
            <span style="color: #fe8019;">shift</span>
            ;;
        -d|--directory)
            <span style="color: #fe8019;">shift</span>
            <span style="color: #83a598;">GIT_DIR</span>=<span style="color: #b8bb26;">"</span><span style="color: #fdf4c1; background-color: #282828;">$</span><span style="color: #83a598;">1</span><span style="color: #b8bb26;">"</span>
            <span style="color: #fe8019;">shift</span>
            ;;
        -v|--verbose)
            <span style="color: #83a598;">VERBOSE</span>=<span style="color: #b8bb26;">'</span><span style="color: #b8bb26;">true</span><span style="color: #b8bb26;">'</span>
            <span style="color: #fe8019;">shift</span>
            ;;
        -*)
            <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"ERROR: unknown option '</span><span style="color: #fdf4c1; background-color: #282828;">$</span><span style="color: #83a598;">arg</span><span style="color: #b8bb26;">'"</span>
            <span style="color: #fe8019;">echo</span>
            <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"USAGE:"</span>
            usage
            <span style="color: #fe8019;">exit</span> 1
            ;;
    <span style="color: #fb4933;">esac</span>
<span style="color: #fb4933;">done</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">prefix directory</span>
<span style="color: #83a598;">PREFIX</span>=${<span style="color: #83a598;">PREFIX</span>:-$<span style="color: #83a598;">HOME</span>}

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">verbose flag</span>
<span style="color: #83a598;">VERBOSE</span>=${<span style="color: #83a598;">VERBOSE</span>:-<span style="color: #b8bb26;">'</span><span style="color: #b8bb26;">false</span><span style="color: #b8bb26;">'</span>}

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">the URI of your existing repo</span>
<span style="color: #fb4933;">if</span> [ -z <span style="color: #b8bb26;">"</span><span style="color: #fdf4c1; background-color: #282828;">$</span><span style="color: #83a598;">1</span><span style="color: #b8bb26;">"</span> ]; <span style="color: #fb4933;">then</span>
    <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"ERROR: missing positional argument &lt;URI&gt;"</span>
    <span style="color: #fe8019;">echo</span>
    <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"USAGE:"</span>
    usage
    <span style="color: #fe8019;">exit</span> 2
<span style="color: #fb4933;">else</span>
    <span style="color: #83a598;">GIT_URI</span>=$<span style="color: #83a598;">1</span>
<span style="color: #fb4933;">fi</span>

<span style="color: #fb4933;">if</span> ! [ -x <span style="color: #d3869b;">"$(</span><span style="color: #d3869b;">command</span><span style="color: #d3869b;"> -v ecryptfs-mount-private)</span><span style="color: #b8bb26;">"</span> ]; <span style="color: #fb4933;">then</span>
    <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"ERROR: the necessary ecryptfs tooling isn't available"</span>
    <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"  please </span><span style="color: #b8bb26;">install</span><span style="color: #b8bb26;"> 'ecryptfs-utils'"</span>
    <span style="color: #fe8019;">exit</span> 3
<span style="color: #fb4933;">fi</span>

<span style="color: #fb4933;">if</span> ! [ -x <span style="color: #d3869b;">"$(</span><span style="color: #d3869b;">command</span><span style="color: #d3869b;"> -v </span><span style="color: #d3869b;">git</span><span style="color: #d3869b;">)</span><span style="color: #b8bb26;">"</span> ]; <span style="color: #fb4933;">then</span>
   <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"ERROR: </span><span style="color: #b8bb26;">git</span><span style="color: #b8bb26;"> isn't available"</span>
   <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"  please </span><span style="color: #b8bb26;">install</span><span style="color: #b8bb26;"> '</span><span style="color: #b8bb26;">git</span><span style="color: #b8bb26;">'"</span>
   <span style="color: #fe8019;">exit</span> 3
<span style="color: #fb4933;">fi</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">final </span><span style="color: #7c6f64;">git</span><span style="color: #7c6f64;"> directory</span>
<span style="color: #83a598;">GIT_DIR</span>=$<span style="color: #83a598;">PREFIX</span>/${<span style="color: #83a598;">GIT_DIR</span>:-$(<span style="color: #d3869b;">basename</span> $<span style="color: #83a598;">GIT_URI</span> .git)}

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">creating the private encripted folder</span>
ecryptfs-setup-private --nopwcheck -noautomount

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">move to a better name</span>
<span style="color: #d3869b;">mv</span> $<span style="color: #83a598;">HOME</span>/Private $<span style="color: #83a598;">GIT_DIR</span>
<span style="color: #fe8019;">echo</span> $(readlink -f $<span style="color: #83a598;">GIT_DIR</span>) &gt; $<span style="color: #83a598;">HOME</span>/.ecryptfs/Private.mnt

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">mount the directory</span>
ecryptfs-mount-private

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">init and pull the repo</span>
<span style="color: #fe8019;">cd</span> $<span style="color: #83a598;">GIT_DIR</span>
<span style="color: #d3869b;">git</span> init
<span style="color: #d3869b;">git</span> remote add origin gcrypt::$<span style="color: #83a598;">GIT_URI</span>
<span style="color: #d3869b;">git</span> pull origin master --allow-unrelated-histories

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">done</span>
[ $<span style="color: #83a598;">VERBOSE</span> = <span style="color: #b8bb26;">'</span><span style="color: #b8bb26;">true</span><span style="color: #b8bb26;">'</span> ] &amp;&amp; <span style="color: #fe8019;">echo</span> <span style="color: #b8bb26;">"INFO: success!"</span>

<span style="color: #fe8019;">exit</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <i>Mount</i> e <i>Unmount</i> do diretório privado criptografado</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Utilize os seguintes comandos para isso:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">usuario@</span><span style="color: #7c6f64;">local</span>

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">para o mount</span>
ecryptfs-mount-private

<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">para o unmount</span>
ecryptfs-unmount-private
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Trabalho no repositório</h3>
<div class="outline-text-3" id="text-4-3">
<p>
A criptografia do remoto é transparente para os clones, assim o <i>workflow</i> é
exatamente igual a qualquer outro repositório comum:
</p>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">usuario@</span><span style="color: #7c6f64;">local</span>

vim &lt;arquivo&gt;
<span style="color: #d3869b;">git</span> commit -am <span style="color: #b8bb26;">"mensagem de commit relevante"</span>
<span style="color: #d3869b;">git</span> push -u origin master
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">ou qualquer outra branch existente</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Utilização de submódulos</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Na sua configuração padrão, o <code>git</code> não permite a utilização de remotos com URIs
com protocolos customizados, como o nosso <code>gcrypt::</code>.
</p>
</div>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Sumário</a></li>
<li><a href="#sec-2">2. Preâmbulo</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. <code>git</code></a></li>
<li><a href="#sec-2-2">2.2. <code>gnupg</code></a></li>
<li><a href="#sec-2-3">2.3. <code>git-remote-gcrypt</code></a></li>
<li><a href="#sec-2-4">2.4. <code>ecryptfs</code></a></li>
</ul>
</li>
<li><a href="#sec-3">3. Hospedando o servidor</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Crie um usuário chamado "git" e um diretório <code>.ssh</code> para ele</a></li>
<li><a href="#sec-3-2">3.2. Adicione os colaboradores</a></li>
<li><a href="#sec-3-3">3.3. Crie o repositório no servidor</a></li>
<li><a href="#sec-3-4">3.4. Inicialize a cópia local</a></li>
<li><a href="#sec-3-5">3.5. Configure o usuário</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Utilizando o servidor</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. <i>Clone</i> do repositório</a></li>
<li><a href="#sec-4-2">4.2. <i>Mount</i> e <i>Unmount</i> do diretório privado criptografado</a></li>
<li><a href="#sec-4-3">4.3. Trabalho no repositório</a></li>
<li><a href="#sec-4-4">4.4. Utilização de submódulos</a></li>
</ul>
</li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div><p class="author">Autor: Henrique Corrêa Pereira da Silva</p>
<p class="date">Criado em: 2020-02-18 ter 17:31</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="http://orgmode.org">Org-mode</a> 9.3.6)</p>
</div>
</footer>
</body>
</html>
